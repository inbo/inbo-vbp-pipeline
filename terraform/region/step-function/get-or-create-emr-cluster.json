{
  "Comment": "Get or create a EMR Cluster",
  "StartAt": "Get State-machine Config",
  "States": {
    "Get State-machine Config": {
      "Type": "Task",
      "Arguments": {
        "Name": "inbo-vbp-pipelines-config"
      },
      "Resource": "arn:aws:states:::aws-sdk:ssm:getParameter",
      "Next": "Attempt to lock cluster entry",
      "Assign": {
        "config": "{% $parse($states.result.Parameter.Value) %}"
      }
    },
    "Attempt to lock cluster entry": {
      "Type": "Task",
      "Arguments": {
        "TransactItems": [
          {
            "Put": {
              "TableName": "{% $config.dynamodb_table_name %}",
              "Item": {
                "PK": {
                  "S": "{% 'RUN#' & $states.context.Execution.Input.rootPipelineName %}"
                },
                "SK": {
                  "S": "RUN"
                },
                "ClusterId": {
                  "S": "LOCKED"
                },
                "TTL": {
                  "N": "{% $string($millis() + 600000) %}"
                }
              },
              "ConditionExpression": "attribute_not_exists(ClusterId)"
            }
          }
        ]
      },
      "Resource": "arn:aws:states:::aws-sdk:dynamodb:transactWriteItems",
      "Next": "EMR CreateCluster",
      "Catch": [
        {
          "ErrorEquals": ["DynamoDb.TransactionCanceledException"],
          "Next": "Store start wait timestamp"
        }
      ]
    },
    "Store start wait timestamp": {
      "Type": "Pass",
      "Next": "DynamoDB GetItem",
      "Assign": {
        "startWait": "{% $millis() %}"
      }
    },
    "DynamoDB GetItem": {
      "Type": "Task",
      "Resource": "arn:aws:states:::dynamodb:getItem",
      "Arguments": {
        "TableName": "{% $config.dynamodb_table_name %}",
        "Key": {
          "PK": {
            "S": "{% 'RUN#' & $states.context.Execution.Input.rootPipelineName %}"
          },
          "SK": {
            "S": "RUN"
          }
        }
      },
      "Next": "Choice"
    },
    "Choice": {
      "Type": "Choice",
      "Choices": [
        {
          "Next": "Return ClusterId",
          "Condition": "{% $exists($states.input.Item.ClusterId.S) and $states.input.Item.ClusterId.S != \"LOCKED\" %}",
          "Assign": {
            "clusterId": "{% $states.input.Item.ClusterId.S %}"
          }
        },
        {
          "Next": "Timeout",
          "Condition": "{% $millis() > $number($states.input.Item.TTL.N) %}"
        }
      ],
      "Default": "Wait"
    },
    "Wait": {
      "Type": "Wait",
      "Seconds": 5,
      "Next": "DynamoDB GetItem"
    },
    "EMR CreateCluster": {
      "Type": "Task",
      "Resource": "arn:aws:states:::elasticmapreduce:createCluster",
      "Arguments": {
        "Name": "PipelinesCluster",
        "ServiceRole": "{% $config.iam_emr_service_role_arn %}",
        "JobFlowRole": "{% $config.iam_emr_instance_profile_arn %}",
        "Tags": "{% $config.emr_tags %}",
        "ReleaseLabel": "{% $config.emr_release %}",
        "LogUri": "{% 's3://' & $config.s3_bucket_name_pipeline & '/logs' %}",
        "EbsRootVolumeSize": "{% $config.ebs_root_volume_size %}",
        "AutoTerminationPolicy": {
          "IdleTimeout": "{% $config.idle_timout_termination_seconds %}"
        },
        "StepConcurrencyLevel": "{% $config.emr_step_concurrency_limit %}",
        "Applications": [
          {
            "Name": "Hadoop"
          },
          {
            "Name": "Spark"
          }
        ],
        "VisibleToAllUsers": true,
        "Instances": {
          "Ec2SubnetId": "{% $config.ec2_subnet_id %}",
          "EmrManagedMasterSecurityGroup": "{% $config.emr_managed_master_security_group %}",
          "EmrManagedSlaveSecurityGroup": "{% $config.emr_managed_slave_security_group %}",
          "ServiceAccessSecurityGroup": "{% $config.service_access_security_group %}",
          "AdditionalMasterSecurityGroups": [
            "{% $config.batch_security_group %}"
          ],
          "AdditionalSlaveSecurityGroups": [
            "{% $config.batch_security_group %}"
          ],
          "KeepJobFlowAliveWhenNoSteps": true,
          "InstanceGroups": [
            {
              "InstanceRole": "MASTER",
              "Name": "Master",
              "InstanceCount": 1,
              "InstanceType": "{% $config.master_ec2_instance_type %}"
            },
            {
              "InstanceRole": "CORE",
              "Name": "Core",
              "InstanceCount": "{% $config.min_number_of_core_workers %}",
              "InstanceType": "{% $config.worker_ec2_instance_type %}"
            }
          ]
        },
        "Configurations": [
          {
            "Classification": "spark",
            "Properties": {
              "maximizeResourceAllocation": "true"
            }
          },
          {
            "Classification": "spark-defaults",
            "Properties": {
              "spark.dynamicAllocation.enabled": "true",
              "spark.eventLog.overwrite": "true"
            }
          },
          {
            "Classification": "hdfs-site",
            "Properties": {
              "fs.s3a.connection.maximum": "100"
            }
          },
          {
            "Classification": "spark-env",
            "Configurations": [
              {
                "Classification": "export",
                "Properties": {
                  "APIKEY": "{% $config.apikey_secret_value %}"
                }
              }
            ]
          },
          {
            "Classification": "spark-log4j2",
            "Properties": {
              "rootLogger.level": "INFO",
              "appender.console.layout.pattern": "%d{DEFAULT} [%level] %logger{1.}: %m%n%ex"
            }
          }
        ],
        "BootstrapActions": [
          {
            "Name": "cloudwatch",
            "ScriptBootstrapAction": {
              "Args": [],
              "Path": "{% 's3://' & $config.s3_bucket_name_pipeline & '/bootstrap-actions/cloudwatch.sh' %}"
            }
          },
          {
            "Name": "mount-data",
            "ScriptBootstrapAction": {
              "Args": [
                "{% $config.collectory_data_volume_id %}",
                "{% $config.collectory_data_access_point_id %}",
                "/data"
              ],
              "Path": "{% 's3://' & $config.s3_bucket_name_pipeline & '/bootstrap-actions/mount-efs.sh' %}"
            }
          },
          {
            "Name": "install-pipelines",
            "ScriptBootstrapAction": {
              "Args": [
                "{% $config.api_key_secret_arn %}",
                "{% $config.s3_bucket_name_pipeline %}",
                "{% $config.pipelines_version %}"
              ],
              "Path": "{% 's3://' & $config.s3_bucket_name_pipeline & '/bootstrap-actions/install-pipelines.sh' %}"
            }
          }
        ]
      },
      "Next": "Write actual clusterId",
      "Assign": {
        "clusterId": "{% $states.result.ClusterId %}"
      }
    },
    "Write actual clusterId": {
      "Type": "Task",
      "Arguments": {
        "TransactItems": [
          {
            "Put": {
              "TableName": "{% $config.dynamodb_table_name %}",
              "Item": {
                "PK": {
                  "S": "{% 'RUN#' & $states.context.Execution.Input.rootPipelineName %}"
                },
                "SK": {
                  "S": "RUN"
                },
                "ClusterId": {
                  "S": "{% $clusterId %}"
                },
                "TTL": {
                  "N": "{% $string($millis() + 86400000) %}"
                }
              },
              "ExpressionAttributeValues": {
                ":locked": {
                  "S": "LOCKED"
                }
              },
              "ConditionExpression": "ClusterId = :locked"
            }
          }
        ]
      },
      "Resource": "arn:aws:states:::aws-sdk:dynamodb:transactWriteItems",
      "Next": "Return ClusterId"
    },
    "Return ClusterId": {
      "Type": "Pass",
      "End": true,
      "Output": {
        "clusterId": "{% $clusterId %}"
      }
    },
    "Timeout": {
      "Type": "Fail",
      "Error": "TimedOutWaitingForEMRCluster",
      "Cause": "Timed out waiting for an emr cluster to be started"
    }
  },
  "QueryLanguage": "JSONata"
}
